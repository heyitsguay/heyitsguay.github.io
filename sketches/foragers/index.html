<!DOCTYPE html>
<html>
<head>
    <!--<link href='http://fonts.googleapis.com/css?family=Arvo' rel='stylesheet' type='text/css'>-->
    <script type="text/javascript" src="libs/gl-matrix-min.js"></script>
    <script type="text/javascript" src="libs/lodash.min.js"></script>
    <script type="text/javascript" src="libs/quadtree.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <!--<script type="text/javascript" src="libs/webgl-debug.js"></script>-->
    <style>
        * {margin: 0; padding: 0;}
        html,
        body {
            font-family: Monospace;
            text-align: center;
            background-color: #000000;
            color: #CECECE;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            width: 100%;
            height: 100%;
            margin: 0;
            overflow-y: hidden;
            overflow-x: hidden;
        }
        canvas {
            display: block;
            position: absolute;
            /*top: 0;*/
            /*left: 0;*/
            /*right: 0;*/
            /*bottom: 0;*/
            /*width: 20%;*/
            /*height: 100%;*/
            margin: auto;
            border: 1px solid #222222;
        }
    </style>
    <style id="h1-4">
        h1 {
            color: #CECECE;
            /*margin-top: 10px;*/
            /*border-bottom: 1px solid;*/
            padding-bottom: 3px;
        }
        h2,h3,h4 {
            /*font-family: 'Helvetica', sans-serif;*/
            color: #CECECE;
        }
    </style>

    <style type="text/css" id="canvas-noselect">
        canvas {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
        }
    </style>

    <style type="text/css" id="mydiv">
        .mydiv {
            display: block;
            width: 100%;
            background-color: black;
            color: #CECECE;
            /*font-family: 'Helvetica', sans-serif;*/
        }
        .mydiv br {
            display: none;
        }

        .mydiv1 {
            display: block;
            background-color: transparent;
            position: absolute;
            z-index: 1;
            /*top: 0;*/
            /*left: 0;*/
            color: #CECECE
            /*font-framily: 'Helvetica', sans-serif;*/
            font-size: 12pt;
            text-align: left;
            float: left;
        }
    </style>

    <style type="text/css" id="table-center">
        table.center {
            margin-left: auto;
            margin-right: auto;
        }
    </style>

    <style type="text/css" id="table-ss">
        table.ss{
            /*font-family: 'Helvetica', sans-serif;*/
            font-size: 10pt;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
            float: left;
            table-layout: fixed;
            width: 220px;
            /*border: 1px solid;*/
            border-spacing: 1px;
            position: absolute;
            color: #CECECE;
        }
    </style>

    <style type="text/css" id="table-checktable">
        table.checktable td {
            table-layout: fixed;
            width: 100px;
            text-align: left;
            float: left;
            color: #CECECE;
        }
    </style>

    <style type="text/css">
        div.instrdiv {
            text-align: right;
            float: right;
            top: 10px;
            color: #CECECE;
            position: absolute;
            font-size: 12pt;
        }
    </style>

    <style type="text/css">
        .toggle {}
    </style>

    <!--Shaders begin ------------------------------------------------------------------------------------------------->
    <!--Fragment shaders-->
    <script id="fs_entityupdate" type="x-shader/x-fragment">
        precision highp float;

        varying float v_heat;
        varying float v_lifeleft;

        const float heatoffset = 0.00001;

        void main()
        {
            gl_FragColor = vec4(heatoffset * v_heat, v_lifeleft, 0.0, 1.0);
        }
    </script>
    <script id="fs_diffuse" type="x-shader/x-fragment">
        precision highp float;

        uniform vec2 u_dst;
        uniform float u_cdiff;
        uniform float u_cdecay;
        uniform float u_lifeleft;

        uniform sampler2D s_heat;
        uniform sampler2D s_entity;

        //const vec2 rad = vec2(4.0, 4.0);
        const float w1 = 1.0;//0.1464466; // NESW neighbor weighting
        const float w2 = 0.5;//0.1035534; // diagonal neighbor weighting
        const float w3 = 6.0;//1.0; // self weighting

        void main()
        {
            vec2 p  = gl_FragCoord.xy * u_dst;

            float lifeleft = texture2D(s_entity, p).g;

            lifeleft += float(lifeleft < 0.00000001);

            float ds = u_dst[0];
            float dt = u_dst[1];


            vec2 n  = p + vec2( 0.,  dt);
            vec2 ne = p + vec2( ds,  dt);
            vec2 e  = p + vec2( ds,  0.);
            vec2 se = p + vec2( ds, -dt);
            vec2 s  = p + vec2( 0., -dt);
            vec2 sw = p + vec2(-ds, -dt);
            vec2 w  = p + vec2(-ds,  0.);
            vec2 nw = p + vec2(-ds,  dt);

            float valp  = texture2D(s_heat, p ).r + texture2D(s_entity, p ).r;
            float valn  = texture2D(s_heat, n ).r + texture2D(s_entity, n ).r;
            float valne = texture2D(s_heat, ne).r + texture2D(s_entity, ne).r;
            float vale  = texture2D(s_heat, e ).r + texture2D(s_entity, e ).r;
            float valse = texture2D(s_heat, se).r + texture2D(s_entity, se).r;
            float vals  = texture2D(s_heat, s ).r + texture2D(s_entity, s ).r;
            float valsw = texture2D(s_heat, sw).r + texture2D(s_entity, sw).r;
            float valw  = texture2D(s_heat, w ).r + texture2D(s_entity, w ).r;
            float valnw = texture2D(s_heat, nw).r + texture2D(s_entity, nw).r;



            float laplacian = w1 * (valn  + vale  + vals  + valw )
                            + w2 * (valne + valse + valsw + valnw)
                            - w3 * valp;

            float deathburst = 0.1 * max(0.0, 0.01 - lifeleft * lifeleft);

            float newval =  u_cdecay * (valp + u_cdiff * laplacian) + deathburst;

            gl_FragColor = vec4(newval, lifeleft, 0.0, 1.0);
        }
    </script>
    <script id="fs_drawheat" type="x-shader/x-fragment">
        precision highp float;

        uniform vec2 u_dst;
        uniform float u_heatH;
        uniform float u_Hgate;
//        uniform float u_Sgate;
        uniform sampler2D s_heat;

        const float hoffset = 10000.;
        const vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);

        // Thanks to sam at http://lolengine.net/blog/2013/07/27/rgb-to-hsv-in-glsl (May 19, 2015).
        vec3 hsv2rgb(vec3 c)
        {
            vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
            vec3 rgb = c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
            return rgb;
        }

//        void main()
//        {
//            vec2 texvals = texture2D(s_heat, gl_FragCoord.xy * u_dst).rg;
//            float heat = hoffset * texvals[0];
//            //float lifeleft = texvals[1];
//
//            float tH1 = min(0.15, u_Hgate * 0.2 * heat);
//            float tH2 = max(0.0, u_Hgate * (heat - 50.0));
//            gl_FragColor = vec4(hsv2rgb(vec3(mod(u_heatH + tH1 + tH2, 1.0), 1.0, min(1.0, 0.2 * heat))), 1.0);
//        }
        void main()
        {
            vec2 texvals = texture2D(s_heat, gl_FragCoord.xy * u_dst).rg;
            float heat = hoffset * texvals[0];
            //float lifeleft = texvals[1];

            float tH = u_Hgate * heat;
            gl_FragColor = vec4(hsv2rgb(vec3(mod(u_heatH + tH, 1.0), 1.0, min(1.0, heat))), 1.0);
        }
    </script>
    <script id="fs_entitydraw" type="x-shader/x-fragment">
        precision highp float;

        varying vec4 v_color;

        void main()
        {
            gl_FragColor = v_color;
        }
    </script>

    <!--Vertex shaders-->
    <script id="vs_entityupdate" type="x-shader/x-vertex">
        attribute vec2 a_position;
        attribute float a_heat;
        attribute float a_lifeleft;

        varying float v_heat;
        varying float v_lifeleft;

        void main()
        {
            gl_Position = vec4(a_position, 0.0, 1.0);
            v_heat = a_heat;
            v_lifeleft = a_lifeleft;
        }
    </script>
    <script id="vs_screen" type = "x-shader/x-vertex">
        attribute vec2 a_position;

        void main()
        {
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    </script>
    <script id="vs_entitydraw" type="x-shader/x-vertex">
        attribute vec2 a_position;
        attribute vec4 a_color;

        varying vec4 v_color;

        void main()
        {
            gl_Position = vec4(a_position, 0.0, 1.0);
            v_color = a_color;
        }
    </script>

    <!--Objects to simplify working with WebGL.-->
    <script type="text/javascript" src="glhelpers.js"></script>
    <!--Event handlers.-->
    <script type="text/javascript" src="handles.js"></script>
    <!--Contains all the initialization scripts.-->
    <script type="text/javascript" src="inits.js"></script>
    <!--Contains properties and methods of the Pellet object.-->
    <script type="text/javascript" src="pellet.js"></script>
    <!--Contains properties and methods of the Forager object.-->
    <script type="text/javascript" src="forager.js"></script>
    <!--Common global variable definitions, update and drawing functions, some auxiliary functions.-->
    <script type="text/javascript" src="main.js"></script>

</head>

<body onload="webGLStart();">
    <!--Title-->
    <div class="mydiv1 toggle" id="title"><h1>foragers</h1></div>
    <!--FPS counter-->
    <div class="mydiv1 toggle" id="fpscounter"> </div>
    <!-- Quality settings-->
    <div class="mydiv1 toggle" id="settings" onchange="qualityChange()">
        Quality:<br/>
        <table id="quality" style="border-spacing: 5px;"><tr>
            <td><input type="radio" name="q1" value="low"/></td><td>Low</td>
            <td><input type="radio" name="q1" value="medium" checked/></td><td>Medium</td>
            <td><input type="radio" name="q1" value="high" /></td><td>High</td>
            <td><input type="radio" name="q1" value="best" /></td><td>Best</td>
        </tr></table>

        Size:<br/>
        <table id="size" style="border-spacing: 5px;"><tr>
            <td><input type="radio" name="q2" value="100" checked/></td><td>100%</td>
            <td><input type="radio" name="q2" value="half"/></td><td>Half window</td>
            <td><input type="radio" name="q2" value="full"/></td><td>Full window</td>
        </tr></table>

        </fieldset>
    </div>

    <!--The canvas-->
    <canvas id="canvas" width="512" height="512"></canvas>

    <div class="instrdiv toggle" id="instructions">
        WASD to move<br/>
        P/O to raise/lower player heat<br/>
        L/K to add/remove foragers<br/>
        H to toggle text display
    </div>

    <div class="mydiv1 toggle" id="checkboxes">
        <table class="checktable">
            <colgroup>
                <col span="1" style="width: 60%;">
                <col span="1" style="width: 40%;">
            </colgroup>
            <tr>
                <td>Draw entities: </td><td><label for="check-draw"></label><input type="checkbox" id="check-draw" onchange="entityDrawToggle()"/></td>
            </tr>
            <!--<tr>-->
                <!--<td>Show sliders: </td><td><label for="check-sliders"></label><input type="checkbox" id="check-sliders" onchange="sliderToggle(this.checked)" checked/></td>-->
            <!--</tr>-->
            <tr>
                <td>Add pellets: </td><td><label for="check-pellets"></label><input type="checkbox" id="check-pellets" onchange="pelletToggle()" checked/></td>
            </tr>
        </table>
    </div>
    <!--Slider bar table-->
    <table class="ss toggle" id="table-sliders">
        <colgroup>
            <col span="1" style="width: 33%;">
            <col span="1" style="width: 45%;">
            <col span="1" style="width: 22%;">
        </colgroup>
        <!--Heat decay slider bar-->
        <tr>
            <td>Decay</td>
            <td><label for="range-cdecay"></label><input type="range" id="range-cdecay" style="width: 80px;"
                   min="0" max="15" value="8" step="1"
                   onchange="cdecaySlider(this.value)"
                   oninput="cdecaySlider(this.value)"/></td>
            <td id="range-cdecay-disp">8</td>
        </tr>
        <!--Diffusion speed slider bar-->
        <tr>
            <td>Diffusion</td>
            <td><label for="range-cdiff"></label><input type="range" id="range-cdiff" style="width: 80px;"
                    min="0" max="1" value="0.3" step="0.01"
                    onchange="cdiffSlider(this.value)"
                    oninput="cdiffSlider(this.value)"/></td>
            <td id="range-cdiff-disp">0.3</td>
        </tr>
        <!--Base heat color slider bar-->
        <tr>
            <td>Hue</td>
            <td><label for="range-heatH"></label><input type="range" id="range-heatH" style="width: 80px;"
                    min="0" max="1" value="0" step="0.01"
                    onchange="heatHSlider(this.value)"
                    oninput="heatHSlider(this.value)"/></td>
            <td id="range-heatH-disp">0</td>
        </tr>
        <!--Hgate slider bar-->
        <tr>
            <td>Glow</td>
            <td><label for="range-Hgate"></label><input type="range" id="range-Hgate" style="width: 80px;"
                   min="0" max="100" value="3" step="1"
                   onchange="HgateSlider(this.value)"
                   oninput="HgateSlider(this.value)"/></td>
            <td id="range-Hgate-disp">3</td>
        </tr>
        <!--&lt;!&ndash;Sgate slider bar&ndash;&gt;-->
        <!--<tr>-->
            <!--<td>Saturation multiplier</td>-->
            <!--<td><label for="range-Sgate"></label><input type="range" id="range-Sgate"-->
                    <!--min="0" max="100" value="0" step="1"-->
                    <!--onchange="SgateSlider(this.value)"-->
                    <!--oninput="SgateSlider(this.value)"/></td>-->
            <!--<td id="range-Sgate-disp">0</td>-->
        <!--</tr>-->
    </table>
</body>
</html>